open! Core
open! Hardcaml
open! Hardcaml_waveterm
open! Hardcaml_test_harness
module Day7 = Aoc25.Day7
module Harness = Cyclesim_harness.Make (Day7.I) (Day7.O)

let ( <--. ) = Bits.( <--. )

(* Start reference impl. Ported from the Python solution *)
let update_splitter_at ~i ~v j x =
  match j - i with
  | 0 -> x + v
  | 1 -> 0
  | 2 -> x + v
  | _ -> x
;;

let update_splitters splitters ~i ~v = List.mapi splitters ~f:(update_splitter_at ~i ~v)

let process_cell (col, splitters) caret =
  let v = List.nth_exn splitters (col + 1) in
  let splitters' =
    if caret && v <> 0 then update_splitters splitters ~i:col ~v else splitters
  in
  col + 1, splitters'
;;

let process_row ~width splitters row =
  assert (List.length row = width);
  let _, splitters' = List.fold_left row ~init:(0, splitters) ~f:process_cell in
  splitters'
;;

let make_initial_splitters ~width ~s_col =
  List.init (width + 2) ~f:(fun i -> if i = s_col + 1 then 1 else 0)
;;

let reference ~width ~s_col ~rows : int =
  let initial_splitters = make_initial_splitters ~width ~s_col in
  let final_splitters =
    rows |> List.tl_exn |> List.fold_left ~init:initial_splitters ~f:(process_row ~width)
  in
  List.fold_left final_splitters ~init:0 ~f:( + )
;;

(* End reference impl *)

let simple_testbench (sim : Harness.Sim.t) =
  let inputs = Cyclesim.inputs sim in
  let outputs = Cyclesim.outputs sim in
  let cycle ?n () = Cyclesim.cycle ?n sim in
  (* Generated using day7_pre.py *)
  let width = 7 in
  let s_col = 3 in
  let rows =
    [ [ false; false; false; false; false; false; false ]
    ; [ false; false; false; true; false; false; false ]
    ; [ false; false; true; false; true; false; false ]
    ; [ false; true; false; true; false; true; false ]
    ]
  in
  let expected = reference ~width ~s_col ~rows in
  let pulse1 (x : Bits.t ref) =
    x := Bits.vdd;
    cycle ();
    x := Bits.gnd
  in
  let send_param ~width ~s_col =
    inputs.width <--. width;
    inputs.width_valid := Bits.vdd;
    cycle ();
    inputs.width_valid := Bits.gnd;
    cycle ();
    inputs.s_col <--. s_col;
    inputs.s_valid := Bits.vdd;
    cycle ();
    inputs.s_valid := Bits.gnd;
    cycle ()
  in
  let send_cell caret =
    inputs.data_in := if caret then Bits.vdd else Bits.gnd;
    inputs.data_in_valid := Bits.vdd;
    cycle ();
    inputs.data_in_valid := Bits.gnd;
    cycle ()
  in
  (* Reset *)
  inputs.clear := Bits.vdd;
  cycle ();
  inputs.clear := Bits.gnd;
  cycle ();
  (* Provide params, then start *)
  send_param ~width ~s_col;
  pulse1 inputs.start;
  cycle ();
  (* Send all rows *)
  List.iter rows ~f:(fun row -> List.iter row ~f:send_cell);
  (* Finish, then wait for answer.valid *)
  pulse1 inputs.finish;
  cycle ();
  while not (Bits.to_bool !(outputs.answer.valid)) do
    cycle ()
  done;
  let got = Bits.to_unsigned_int !(outputs.answer.value) in
  print_s [%message "Result" (got : int) (expected : int)];
  (* Show it stays valid *)
  cycle ~n:2 ()
;;

let waves_config = Waves_config.no_waves

let%expect_test "Day7 test" =
  Harness.run_advanced ~waves_config ~create:Day7.hierarchical simple_testbench;
  [%expect {| (Result (got 8) (expected 8)) |}]
;;

let%expect_test "Day7 test with printing waveforms directly" =
  let display_rules =
    [ Display_rule.port_name_matches
        ~wave_format:(Bit_or Unsigned_int)
        (Re.compile (Re.Glob.glob "day7*"))
    ]
  in
  Harness.run_advanced
    ~create:Day7.hierarchical
    ~trace:`All_named
    ~print_waves_after_test:(fun waves ->
      Waveform.print
        ~display_rules
        ~signals_width:36
        ~display_width:308
        ~wave_width:1
        waves)
    simple_testbench;
  [%expect
    {|
    (Result (got 8) (expected 8))
    ┌Signals───────────────────────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │day7$i$clear                      ││────┐                                                                                                                                                                                                                                                                         │
    │                                  ││    └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │day7$i$clock                      ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │day7$i$data_in                    ││                                                                                                                ┌───────┐                                       ┌───────┐       ┌───────┐                       ┌───────┐       ┌───────┐       ┌───────┐                     │
    │                                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘       └───────────────────────────────────────┘       └───────┘       └───────────────────────┘       └───────┘       └───────┘       └─────────────────────│
    │day7$i$data_in_valid              ││                                ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐                 │
    │                                  ││────────────────────────────────┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └─────────────────│
    │day7$i$finish                     ││                                                                                                                                                                                                                                                                ┌───┐         │
    │                                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘   └─────────│
    │                                  ││────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │day7$i$s_col                      ││ 0              │3                                                                                                                                                                                                                                                            │
    │                                  ││────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │day7$i$s_valid                    ││                ┌───┐                                                                                                                                                                                                                                                         │
    │                                  ││────────────────┘   └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │day7$i$start                      ││                        ┌───┐                                                                                                                                                                                                                                                 │
    │                                  ││────────────────────────┘   └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                                  ││────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │day7$i$width                      ││ 0      │7                                                                                                                                                                                                                                                                    │
    │                                  ││────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │day7$i$width_valid                ││        ┌───┐                                                                                                                                                                                                                                                                 │
    │                                  ││────────┘   └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │day7$o$answer$valid               ││                                                                                                                                                                                                                                                                    ┌─────────│
    │                                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘         │
    │                                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────────│
    │day7$o$answer$value               ││ 0                                                                                                                                                                                                                                                                  │8        │
    │                                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴─────────│
    └──────────────────────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
;;
